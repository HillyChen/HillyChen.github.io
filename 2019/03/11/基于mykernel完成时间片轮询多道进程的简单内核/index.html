<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><meta name="keywords" content="hexo,blog,博客,github,sunniberg,chenxushan,陈旭山"><title>基于mykernel完成时间片轮询多道进程的简单内核 | 草泥上的蚂蚁</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于mykernel完成时间片轮询多道进程的简单内核</h1><a id="logo" href="/.">草泥上的蚂蚁</a><p class="description">知无不言  言无不尽</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a><a href="/cxsresume.html"><i class="fa undefined"> resume</i></a><a href="/resource/"><i class="fa undefined"> resource</i></a><a href="/movie-music"><i class="fa undefined"> movie&amp;music</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">基于mykernel完成时间片轮询多道进程的简单内核</h1><div class="post-meta"><span class="date">Mar 11, 2019</span><span class="category"><a href="/categories/linux-mykernel-操作系统/">linux,mykernel,操作系统</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i> Hits</i></i></span><a href="/2019/03/11/基于mykernel完成时间片轮询多道进程的简单内核/#comments" class="comment-count"> 留言</a></div><div class="post-content"><h3 id="基于mykernel完成时间片轮询多道进程的简单内核"><a href="#基于mykernel完成时间片轮询多道进程的简单内核" class="headerlink" title="基于mykernel完成时间片轮询多道进程的简单内核"></a>基于mykernel完成时间片轮询多道进程的简单内核</h3><blockquote>
<p>原创作品转载请注明出处+中科大孟宁老师的linux操作系统分析:<a href="https://github.com/mengning/linuxkernel/" target="_blank" rel="external">https://github.com/mengning/linuxkernel/</a> </p>
</blockquote>
<h4 id="操作系统概述"><a href="#操作系统概述" class="headerlink" title="操作系统概述"></a>操作系统概述</h4><blockquote>
<p>操作系统中，OS的任务有很多，比如内存管理、文件管理、进程管理等等，而这其中，进程的管理是至关重要的，因为只有实现了进程的管理，才能使得一个操作系统可以处理多种任务，通过进程的切换，可以从逻辑上实现任务的多个进程任务并行操作，使得操作系统可以更高效的服务于应用服务。本实验着重基于linuxkernel实现一个时间片轮转多道程序内核代码</p>
<h4 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h4><p>Ubuntu 18.04、vim、gcc、vscode、QEMU</p>
</blockquote>
<h4 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h4><p>首先安装QEMU工具，后面需要它显示内核执行的过程，可以UI展示<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install qemu <span class="comment"># install QEMU</span></div><div class="line">sudo ln -s /usr/bin/qemu-system-i386 /usr/bin/qemu</div></pre></td></tr></table></figure></p>
<p>然后下载基于3.9.4版本的linux内核和孟老师基于内核裁剪出来的补丁(给孟宁老师实力点赞)，然后进行解压和打补丁<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">wget https://www.kernel.org/pub/linux/kernel/v3.x/linux-<span class="number">3.9</span>.<span class="number">4</span>.tar.xz <span class="comment"># download Linux Kernel 3.9.4 source code</span></div><div class="line">wget https://raw.github.com/mengning/mykernel/master/mykernel_for_linux3.<span class="number">9.4</span>sc.patch <span class="comment"># download mykernel_for_linux3.9.4sc.patch</span></div><div class="line">xz -d linux-<span class="number">3.9</span>.<span class="number">4</span>.tar.xz</div><div class="line">tar -xvf linux-<span class="number">3.9</span>.<span class="number">4</span>.tar</div><div class="line">cd linux-<span class="number">3.9</span>.<span class="number">4</span></div><div class="line">patch -p1 &lt; ../mykernel_for_linux3.<span class="number">9.4</span>sc.patch</div></pre></td></tr></table></figure></p>
<p>然后就是编译源码，c语言里面可以通过强大的make实现编译，先预处理编译文件，在make编译<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">make allnoconfig</div><div class="line">make</div></pre></td></tr></table></figure></p>
<p>在这一步的时候，会报错，见下图，由于环境没有gcc7，通过网络，定位可以通过将linux-3.9.4/include/linux/下面的<br><img src="http://ww1.sinaimg.cn/large/af1cab2fgy1g0z2pg5c38j20re0emadl.jpg" alt=""><br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /include/linux/</div><div class="line">cp compiler-gcc4.h compiler-gcc5.h</div></pre></td></tr></table></figure></p>
<p>然后在编译成功，如下图<br><img src="http://ww1.sinaimg.cn/large/af1cab2fgy1g0z2ubquulj20v40ygn5f.jpg" alt=""></p>
<p>我们再使用qemu工具来显示代码执行的UI过程<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu -kernel arch/x86/boot/bzImage</div></pre></td></tr></table></figure></p>
<p><img src="http://ww1.sinaimg.cn/large/af1cab2fgy1g0z2wp9jdkj20w00g6jvz.jpg" alt=""></p>
<p>可见我们的内核已经启动成功了，接下来我们就基于孟宁老师的项目代码去实现一个时间轮转多道程序。<br>我们先git clone git@github.com:mengning/mykernel.git代码到本地，然后将其中的myinterrupt.c，mymain.c，mypcb.h三个代码替换上面mykernel文件夹下对于的三个，替换前最好先像cp mymain.c mymain-bak.c这样备份一下，其中要把mypcb.h中的一行代码修改一下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_STACK_SIZE (unsigned long)1024*8</span></div></pre></td></tr></table></figure></p>
<p>替换完之后，在make重新编译一下，这一次编译是让替换之后的代码重新编译，编译速度也会比上次快很多，因为是增量编译。<br><img src="http://ww1.sinaimg.cn/large/af1cab2fgy1g0z36fn6shj20x60hy43w.jpg" alt=""><br>编译完之后，重新执行一下，输入qemu -kernel arch/x86/boot/bzImage<br>结果见下图<br><img src="http://ww1.sinaimg.cn/large/af1cab2fgy1g0z386shz4j20xy0um11g.jpg" alt=""><br>上图可以看出，时间片轮询多道程序已经实现了，总共有4个进程，pid分别为0,1,2,3;<br>下一节我们来分析代码，分析一下孟宁老师给出的简洁高效的实现时间片轮询多道进程的代码，基本深入浅出的阐明了基本工作原理。</p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><h5 id="mypcb-h"><a href="#mypcb-h" class="headerlink" title="mypcb.h"></a>mypcb.h</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_TASK_NUM 10 <span class="comment">// max num of task in system</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_STACK_SIZE (unsigned) long1024*8</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIORITY_MAX 30 <span class="comment">//priority range from 0 to 30</span></span></div><div class="line"><span class="keyword">struct</span> Thread &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	ip;<span class="comment">//point to cpu run address</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	sp;<span class="comment">//point to the thread stack's top address</span></div><div class="line">    <span class="comment">//todo add other attrubte of system thread</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">//PCB Struct</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> PCB&#123;</div><div class="line">    <span class="keyword">int</span> pid; <span class="comment">// pcb id </span></div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> state;	<span class="comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span></div><div class="line">    <span class="keyword">char</span> <span class="built_in">stack</span>[KERNEL_STACK_SIZE];<span class="comment">// each pcb stack size is 1024*8</span></div><div class="line">    <span class="comment">/* CPU-specific state of this task */</span></div><div class="line">    <span class="keyword">struct</span> Thread thread;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	task_entry;<span class="comment">//the task execute entry memory address</span></div><div class="line">    <span class="keyword">struct</span> PCB *next;<span class="comment">//pcb is a circular linked list</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> priority;<span class="comment">// task priority ////////</span></div><div class="line">    <span class="comment">//todo add other attrubte of process control block</span></div><div class="line">&#125;tPCB;</div><div class="line"></div><div class="line"><span class="comment">//void my_schedule(int pid);</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_schedule</span><span class="params">(<span class="keyword">void</span>)</span></span>;</div></pre></td></tr></table></figure>
<blockquote>
<p>首先是mypcb.h，其中定义了两个结构和一个函数。第一个是结构Thread，里面有两个变量，ip和sp用于保存现场。<br>第二个是结构PCB，PCB结构定义了进程管理块，包括6各变量:<br>(1)pid进程标识符;<br>(2)state状态，-1表示不可运行，0表示可运行，&gt;0表示停止;<br>(3)定义了一个栈空间;<br>(4)一个Thread变量;<br>(5)任务入口点;<br>(6)下一个PCB的指针;<br>还定义了一个my_schedule函数，以及两个宏定义。</p>
<h5 id="mymain-c"><a href="#mymain-c" class="headerlink" title="mymain.c"></a>mymain.c</h5><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">tPCB task[MAX_TASK_NUM];</div><div class="line">tPCB * my_current_task = NULL;</div><div class="line">volatile int my_need_sched = 0;</div><div class="line"></div><div class="line">void my_process(void);</div><div class="line">unsigned long get_rand(int );</div><div class="line"></div><div class="line">void sand_priority(void)</div><div class="line">&#123;</div><div class="line">	int i;</div><div class="line">	for(i=0;i&lt;MAX_TASK_NUM;i++)</div><div class="line">		task[i].priority=get_rand(PRIORITY_MAX);</div><div class="line">&#125;</div><div class="line">void __init my_start_kernel(void)</div><div class="line">&#123;</div><div class="line">    int pid = 0;</div><div class="line">    /* Initialize process 0*/</div><div class="line">    task[pid].pid = pid;</div><div class="line">    task[pid].state = 0;/* -1 unrunnable, 0 runnable, &gt;0 stopped */</div><div class="line">    // set task 0 execute entry address to my_process</div><div class="line">    task[pid].task_entry = task[pid].thread.ip = (unsigned long)my_process;</div><div class="line">    task[pid].thread.sp = (unsigned long)&amp;task[pid].stack[KERNEL_STACK_SIZE-1];</div><div class="line">    task[pid].next = &amp;task[pid];</div><div class="line">    /*fork more process */</div><div class="line">    for(pid=1;pid&lt;MAX_TASK_NUM;pid++)</div><div class="line">    &#123;</div><div class="line">        memcpy(&amp;task[pid],&amp;task[0],sizeof(tPCB));</div><div class="line">        task[pid].pid = pid;</div><div class="line">        task[pid].state = -1;</div><div class="line">        task[pid].thread.sp = (unsigned long)&amp;task[pid].stack[KERNEL_STACK_SIZE-1];</div><div class="line">	task[pid].priority=get_rand(PRIORITY_MAX);//each time all tasks get a random priority</div><div class="line">    &#125;</div><div class="line">	task[MAX_TASK_NUM-1].next=&amp;task[0];</div><div class="line">    printk(KERN_NOTICE "\n\n\n\n\n\n                system begin :&gt;&gt;&gt;process 0 running!!!&lt;&lt;&lt;\n\n");</div><div class="line">    /* start process 0 by task[0] */</div><div class="line">    pid = 0;</div><div class="line">    my_current_task = &amp;task[pid];</div><div class="line">asm volatile(</div><div class="line">     "movl %1,%%esp\n\t" /* set task[pid].thread.sp to esp */</div><div class="line">     "pushl %1\n\t" /* push ebp */</div><div class="line">     "pushl %0\n\t" /* push task[pid].thread.ip */</div><div class="line">     "ret\n\t" /* pop task[pid].thread.ip to eip */</div><div class="line">     "popl %%ebp\n\t"</div><div class="line">     :</div><div class="line">     : "c" (task[pid].thread.ip),"d" (task[pid].thread.sp)	/* input c or d mean %ecx/%edx*/</div><div class="line">);</div><div class="line">&#125;</div><div class="line">void my_process(void)</div><div class="line">&#123;</div><div class="line">    int i = 0;</div><div class="line">    while(1)</div><div class="line">    &#123;</div><div class="line">        i++;</div><div class="line">        if(i%10000000 == 0)</div><div class="line">        &#123;</div><div class="line">	  </div><div class="line">            if(my_need_sched == 1)</div><div class="line">            &#123;</div><div class="line">                my_need_sched = 0;</div><div class="line">		sand_priority();</div><div class="line">	   	my_schedule();  </div><div class="line">		</div><div class="line">	   &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;//end of my_process</div><div class="line"></div><div class="line">//produce a random priority to a task</div><div class="line">unsigned long get_rand(max)</div><div class="line">&#123;</div><div class="line">	unsigned long a;</div><div class="line">	unsigned long umax;</div><div class="line">	umax=(unsigned long)max;</div><div class="line"> 	get_random_bytes(&amp;a, sizeof(unsigned long ));</div><div class="line">	a=(a+umax)%umax;</div><div class="line">	return a;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先定义了3个全局变量，两个PCB结构，一个是所有的进程集合，一个是当前的进程。然后是两个函数，my_process和my_start_kernel。<br>我们重点来看一下my_start_kernel函数，函数分为三部分：<br>第一部分，是初始化进程0。pid代表了进程号，0是第一个。state代表运行状态，初始化为可运行。Thread的ip就是进程入口点，其实就是进程运行的起点。sp实际上是定义了一段进程的栈空间。最后定义了下一个PCB的链接先指向自己。<br>第二部分，是根据第一个进程0初始化余下的进程。因为我们设置最大进程数为4，所以这里实际上是设置了进程1-3的数据结构的值。<br>最后一个部分，是从进程0号开始运行。这里使用了内联汇编编程，实际上就是将进程0的thread.sp的值赋给esp，将当前运行的地址保存到栈中，这样如果切换的话就可以保证下一个进程结束时回到原来的位置执行。总而言之,my_start_kernel函数实现了定义进程数组，并运行第一个进程。<br>对于my_process函数来说：<br>就是建立一个循环不断运行进程，并输出表明进程正在运行的语句。这里注意有一个my_schedule()函数，实际上这个函数是在myinterrupt.c中实现的，主要作用是切换进程。</p>
<h5 id="myinterrupt-c"><a href="#myinterrupt-c" class="headerlink" title="myinterrupt.c"></a>myinterrupt.c</h5></blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">void my_schedule(void)</div><div class="line">&#123;</div><div class="line">    tPCB * next;</div><div class="line">    tPCB * prev;</div><div class="line">    // if there no task running or only a task ,it shouldn't need schedule</div><div class="line">    if(my_current_task == NULL</div><div class="line">        || my_current_task-&gt;next == NULL)</div><div class="line">    &#123;</div><div class="line">	printk(KERN_NOTICE "                time out!!!,but no more than 2 task,need not schedule\n");</div><div class="line">     return;</div><div class="line">    &#125;</div><div class="line">    /* schedule */</div><div class="line"></div><div class="line">    next = get_next();</div><div class="line">    prev = my_current_task;</div><div class="line">    printk(KERN_NOTICE "                the next task is %d priority is %u\n",next-&gt;pid,next-&gt;priority);</div><div class="line">    if(next-&gt;state == 0)/* -1 unrunnable, 0 runnable, &gt;0 stopped */</div><div class="line">    &#123;//save current scene</div><div class="line">     /* switch to next process */</div><div class="line">     asm volatile(	</div><div class="line">         "pushl %%ebp\n\t" /* save ebp */</div><div class="line">         "movl %%esp,%0\n\t" /* save esp */</div><div class="line">         "movl %2,%%esp\n\t" /* restore esp */</div><div class="line">         "movl $1f,%1\n\t" /* save eip */	</div><div class="line">         "pushl %3\n\t"</div><div class="line">         "ret\n\t" /* restore eip */</div><div class="line">         "1:\t" /* next process start here */</div><div class="line">         "popl %%ebp\n\t"</div><div class="line">         : "=m" (prev-&gt;thread.sp),"=m" (prev-&gt;thread.ip)</div><div class="line">         : "m" (next-&gt;thread.sp),"m" (next-&gt;thread.ip)</div><div class="line">     );</div><div class="line">     my_current_task = next;//switch to the next task</div><div class="line">    printk(KERN_NOTICE "                switch from %d process to %d process\n                &gt;&gt;&gt;process %d running!!!&lt;&lt;&lt;\n\n",prev-&gt;pid,next-&gt;pid,next-&gt;pid);</div><div class="line"></div><div class="line">  &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        next-&gt;state = 0;</div><div class="line">        my_current_task = next;</div><div class="line">    printk(KERN_NOTICE "                switch from %d process to %d process\n                &gt;&gt;&gt;process %d running!!!&lt;&lt;&lt;\n\n\n",prev-&gt;pid,next-&gt;pid,next-&gt;pid);</div><div class="line"></div><div class="line">     /* switch to new process */</div><div class="line">     asm volatile(	</div><div class="line">         "pushl %%ebp\n\t" /* save ebp */</div><div class="line">         "movl %%esp,%0\n\t" /* save esp */</div><div class="line">         "movl %2,%%esp\n\t" /* restore esp */</div><div class="line">         "movl %2,%%ebp\n\t" /* restore ebp */</div><div class="line">         "movl $1f,%1\n\t" /* save eip */	</div><div class="line">         "pushl %3\n\t"</div><div class="line">         "ret\n\t" /* restore eip */</div><div class="line">         : "=m" (prev-&gt;thread.sp),"=m" (prev-&gt;thread.ip)</div><div class="line">         : "m" (next-&gt;thread.sp),"m" (next-&gt;thread.ip)</div><div class="line">     );</div><div class="line">    &#125;</div><div class="line">    return;	</div><div class="line">&#125;//end of my_schedule</div></pre></td></tr></table></figure>
<blockquote>
<p>首先定义了一些全局变量。然后主要实现了两个函数：my_time_handler和my_schedule，其中my_time_handler实现了中断，而my_schedule实现了中断之后进程的切换。<br> my_time_hander()这个函数也很简单，就是每1000毫秒的时候产生一个中断，产生中断之后把my_need_sched设置为1，这样mymain.c中的my_process函数就会调用my_schedule函数来进行进程切换。<br> my_schedule()实现了时间片轮转的中断处理过程。首先是初始化next和prev两个PCB结构。然后是循环运行代码，就是当下一个进程的state状态是可运行时，说明这个进程之前已经在运行了，此时可以继续执行，就切换到下一个进程，中间有一段内联汇编，实现了保存栈地址和栈指针，这样进程切换回来的时候就可以正常运行。然后根据之前保存的栈地址恢复执行。<br> 当下一个进程的state不为0时，那么也就是说下一个进程还从来都没有执行过，所以这一段内联汇编的作用是开始执行一个新进程。总而言之，在上述函数的作用下，成功地实现了时间片轮转的中断处理内核的功能。通过分析源码，我们了解到时间片轮转算法的具体方法，即每个进程被分配一个时间段，称作它的时间片，即该进程允许运行的时间。如果在时间片结束时进程还在运行，则CPU将被剥夺并分配给另一个进程。如果进程在时间片结束前阻塞或结束，则CPU当即进行切换。调度程序所要做的就是维护一张就绪进程列表，当进程用完它的时间片后，它被移到队列的末尾。这是一种最古老，最简单，最公平且使用最广的算法。</p>
</blockquote>
<h4 id="实验分析"><a href="#实验分析" class="headerlink" title="实验分析"></a>实验分析</h4><blockquote>
<p>当mykernel自制操作系统启动后，即qemu命令执行后，系统会首先调用mymain产生一个进程，该进程内while循环条件恒为1所以永远执行输出“my_start_kernel here”+累计循环次数，没有结束的时候。此时由系统时钟中断触发调用myinterrupt产生一个新进程，并输出“my_timer_handler here”，结束后返回mymain产生的进程继续执行，等待下一次系统时钟中断触发调用myinterrupt产生一个新进程，myinterrupt产生的新进程和上一次的属于不同的进程，而mymain由于循环没有终止的时候，所以永远是原来的那个进程。通过观察可以发现，当执行myinterrupt后返回mymain时，终端输出的累计循环次数是连续的，并没有中断或重置，说明CPU和内核代码共同实现了保存现场和恢复现场的功能，会将一些重要的寄存器，比如eip、ebp、esp等保存下来，等待切换回来的时候继续执行。</p>
</blockquote>
<h4 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h4><blockquote>
<p>通过该实验操作，成功实现了一个简单的时间片轮转多道程序，通过一个精简的操作系统内核，完成了一个简单的操作系统功能。<br>计算机有三个法宝：存储程序计算机、函数调用堆栈、中断操作系统<br>有两把宝剑：中断上下文、进程上下文切换由于CPU只有一套寄存器，同一时间只能处理一个进程（暂且只考虑单核CPU），所以理论上只能单任务顺序执行<br>但基于三个法宝和两把宝剑，操作系统得以实现多任务操作。</p>
</blockquote>
</div><div class="tags"><a href="/tags/linux/">linux</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2019/01/03/linux下gdb调试c-cpp程序/" class="next">linux下gdb调试c/cpp程序</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8yODY5MC81MjYx"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#基于mykernel完成时间片轮询多道进程的简单内核"><span class="toc-text">基于mykernel完成时间片轮询多道进程的简单内核</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#操作系统概述"><span class="toc-text">操作系统概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验环境"><span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验步骤"><span class="toc-text">实验步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#源码分析"><span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mypcb-h"><span class="toc-text">mypcb.h</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mymain-c"><span class="toc-text">mymain.c</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#myinterrupt-c"><span class="toc-text">myinterrupt.c</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验分析"><span class="toc-text">实验分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验总结"><span class="toc-text">实验总结</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-weibo"> 网易云音乐</i></div><iframe width="250" height="250" frameborder="0" scrolling="no" src="//music.163.com/outchain/player?type=0&amp;id=758106745&amp;auto=0&amp;height=430" class="share_self"></iframe></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/UI/">UI</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-cpp/">c/cpp</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-debug-c-cpp/">linux,debug,c,cpp</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-mykernel-操作系统/">linux,mykernel,操作系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/sketch-design/">sketch design</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/博客迁移/">博客迁移</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机基础/">计算机基础</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/博客迁移/" style="font-size: 15px;">博客迁移</a> <a href="/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/c-cpp/" style="font-size: 15px;">c/cpp</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Flask-Nginx-Gunicorn-Supervisor-Ubuntu16-04/" style="font-size: 15px;">Flask,Nginx,Gunicorn,Supervisor,Ubuntu16.04</a> <a href="/tags/计算机基础/" style="font-size: 15px;">计算机基础</a> <a href="/tags/UI/" style="font-size: 15px;">UI</a> <a href="/tags/sketch-design/" style="font-size: 15px;">sketch design</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/11/基于mykernel完成时间片轮询多道进程的简单内核/">基于mykernel完成时间片轮询多道进程的简单内核</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/linux下gdb调试c-cpp程序/">linux下gdb调试c/cpp程序</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/27/Vue-js学习笔记/">Vue.js学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/19/利用Flask-Nginx-Gunicorn-Supervisor在Ubuntu16-04上部署web项目/">利用Flask+Nginx+Gunicorn+Supervisor在Ubuntu16.04上部署web项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/02/Python笔记/">Python笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/24/计算机网络/">计算机网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/29/sketch学习笔记以及设计相关知识积累/">sketch学习笔记以及设计相关知识积累</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/22/css学习笔记/">css学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/16/c-cpp学习笔记/">c/cpp学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/09/Hexo博客迁移部署到oschina-开源中国-coding-码云/">Hexo博客迁移部署到oschina(开源中国)&&codingNet(码市)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-weibo"> 新浪微博</i></div><iframe width="100%" height="400" frameborder="0" scrolling="no" src="https://widget.weibo.com/weiboshow/index.php?language=&amp;width=0&amp;height=550&amp;fansRow=2&amp;ptype=1&amp;speed=0&amp;skin=5&amp;isTitle=0&amp;noborder=0&amp;isWeibo=1&amp;isFans=0&amp;uid=2937891631&amp;verifier=fbb6cab5&amp;colors=ffffff,ffffff,333333,40759b,ecfbfd&amp;dpc=1" class="share_self"></iframe></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://jiyiren.github.io/" title="jiyiren" target="_blank">jiyiren</a><ul></ul><a href="https://scratch.mit.edu" title="scracth" target="_blank">scracth</a><ul></ul><a href="http://www.geeksforgeeks.org" title="geeksforgeeks" target="_blank">geeksforgeeks</a><ul></ul><a href="https://leetcode.com" title="leetcode" target="_blank">leetcode</a><ul></ul><a href="https://www.reddit.com" title="reddit(美国的百度贴吧)" target="_blank">reddit(美国的百度贴吧)</a><ul></ul><a href="https://www.quora.com/" title="Quora(美国的知乎)" target="_blank">Quora(美国的知乎)</a><ul></ul><a href="http://www.pinterest.com" title="pinterest(汇集了这个世界上最美的图集，设计师的最爱，目前被强了，得推墙才能看!)" target="_blank">pinterest(汇集了这个世界上最美的图集，设计师的最爱，目前被强了，得推墙才能看!)</a><ul></ul><a href="https://github.com/jobbole" title="awesome-cn系列" target="_blank">awesome-cn系列</a><ul></ul><a href="https://github.com/computeracy" title="computeracy" target="_blank">computeracy</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">sunniberg.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-93478395-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e93a3164e8e805ff6aa39ba955d338ec";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.0"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.0" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>